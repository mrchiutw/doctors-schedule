<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«å¸«å°ˆç”¨æ™ºèƒ½æ’ç­ç³»çµ±</title>
    <style>
        :root {
            --primary-color: #0056b3; /* é†«ç™‚è— */
            --secondary-color: #f0f7ff; /* æ·ºè—èƒŒæ™¯ */
            --border-color: #dde0e3;
            --text-color: #333;
            --danger-color: #dc3545;
            --night-color: #d32f2f; /* å¤§å¤œç´… */
            --small-night-color: #1976d2; /* å°å¤œè— */
            --off-color: #9e9e9e; /* ä¼‘å‡ç° */
            --weekend-bg: #e9ecef; /* é€±æœ«èƒŒæ™¯ç° */
        }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background-color: #f4f6f8;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 15px;
        }

        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        input, select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-generate {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 86, 179, 0.2);
        }

        .btn-generate:hover { background-color: #004494; transform: translateY(-1px); }

        .btn-print { background-color: #6c757d; color: white; }
        .btn-print:hover { background-color: #5a6268; }

        /* æ–°å¢ Excel æŒ‰éˆ•æ¨£å¼ */
        .btn-excel { background-color: #28a745; color: white; }
        .btn-excel:hover { background-color: #218838; }

        #resultTitle {
            text-align: center;
            margin-top: 40px;
            font-size: 22px;
            color: #333;
            font-weight: bold;
        }

        .table-responsive {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            white-space: nowrap;
        }

        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #f1f8ff; }

        /* æ–°å¢ï¼šé€±æœ«æ¨£å¼ */
        .weekend-row { background-color: var(--weekend-bg) !important; }

        /* ç­åˆ¥é¡è‰² */
        .shift-day { font-weight: bold; color: black; }
        .shift-sn { font-weight: bold; color: var(--small-night-color); }
        .shift-bn { font-weight: bold; color: var(--night-color); }
        .shift-off { color: var(--off-color); }

        /* æ–°å¢ï¼šçµ±è¨ˆå€å¡Šæ¨£å¼ */
        .stats-container {
            margin-top: 40px;
            border-top: 2px dashed #ccc;
            padding-top: 20px;
        }
        .stats-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
            text-align: center;
        }

        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; width: 100%; max-width: none; padding: 0; }
            .input-grid, .btn-group, header { display: none; }
            #resultTitle { margin-top: 0; font-size: 24px; }
            table { font-size: 12px; }
            th { background-color: #ddd !important; color: black !important; -webkit-print-color-adjust: exact; }
            .shift-sn { color: blue !important; }
            .shift-bn { color: red !important; }
            .weekend-row { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ç¸½é†«å¸«çš„æ•‘æ˜Ÿ</h1>
        <p style="color: #666; font-size: 14px; margin-top:5px;">CHIU é•·åºšç´€å¿µé†«é™¢æ’ç­ç³»çµ±</p>
    </header>

    <div class="input-grid">
        <div class="input-group">
            <label for="inputDept">1. ç§‘åˆ¥åç¨±</label>
            <input type="text" id="inputDept" placeholder="ä¾‹å¦‚ï¼šæ€¥è¨ºç§‘" value="æ€¥è¨ºç§‘">
        </div>

        <div class="input-group">
            <label for="inputMonth">2. æœˆä»½ (1-12)</label>
            <input type="number" id="inputMonth" placeholder="è¼¸å…¥æ•¸å­—" min="1" max="12">
        </div>

        <div class="input-group">
            <label for="inputDays">3. æœ¬æœˆå¤©æ•¸</label>
            <input type="number" id="inputDays" placeholder="é è¨­ 30" min="28" max="31" value="30">
        </div>

        <div class="input-group">
            <label for="inputExcluded">4. æŒ‡å®šæ’é™¤é†«å¸«</label>
            <input type="text" id="inputExcluded" placeholder="å¦‚ï¼šé†«å¸«A,é†«å¸«B">
        </div>

        <div class="input-group">
            <label for="selectShift">5. è©²é†«å¸«ä¸æ’ä¹‹ç­åˆ¥</label>
            <select id="selectShift">
                <option value="å¤§å¤œ">å¤§å¤œ</option>
                <option value="å°å¤œ">å°å¤œ</option>
                <option value="ç™½ç­">ç™½ç­</option>
            </select>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-generate" onclick="generateSchedule()">âš¡ é–‹å§‹è‡ªå‹•æ’ç­</button>
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°ç­è¡¨</button>
        <button class="btn-excel" onclick="exportToCSV()">ğŸ“¥ åŒ¯å‡º Excel</button>
    </div>

    <h2 id="resultTitle"></h2>
    
    <div id="tableContainer" class="table-responsive"></div>

    <div id="statsContainer" class="stats-container" style="display:none;">
        <div class="stats-title">ğŸ“Š ç­æ•¸çµ±è¨ˆ (å…¬å¹³æ€§æª¢æŸ¥)</div>
        <div id="statsTable" class="table-responsive"></div>
    </div>
</div>

<script>
    // å…¨åŸŸè®Šæ•¸ï¼Œä¾›åŒ¯å‡ºåŠŸèƒ½ä½¿ç”¨
    let globalScheduleData = [];
    let globalTitle = "";
    let globalDocs = [];

    function generateSchedule() {
        const dept = document.getElementById("inputDept").value.trim();
        const monthVal = document.getElementById("inputMonth").value.trim();
        let daysInMonth = parseInt(document.getElementById("inputDays").value);
        const excludedStr = document.getElementById("inputExcluded").value.trim();
        const targetShift = document.getElementById("selectShift").value;

        // --- é©—è­‰é‚è¼¯ ---
        if (!monthVal || isNaN(monthVal)) {
            alert("ã€éŒ¯èª¤ã€‘æœˆä»½æ ¼å¼éŒ¯èª¤ï¼\nè«‹è¼¸å…¥ 1 åˆ° 12 ä¹‹é–“çš„æ•¸å­—ã€‚");
            return;
        }
        const mNum = parseInt(monthVal);
        if (mNum < 1 || mNum > 12) {
            alert(`ã€éŒ¯èª¤ã€‘æœˆä»½éŒ¯èª¤ï¼\næ‚¨è¼¸å…¥äº†: ${mNum}\nè«‹è¼¸å…¥ 1 åˆ° 12 ä¹‹é–“çš„æ•¸å­—ã€‚`);
            return;
        }

        if (isNaN(daysInMonth) || daysInMonth < 28 || daysInMonth > 31) {
            alert("å¤©æ•¸è¨­å®šç•°å¸¸ (è«‹è¼¸å…¥ 28~31)ï¼Œæœ¬æ¬¡å°‡ä»¥ 30 å¤©è¨ˆç®—ã€‚");
            daysInMonth = 30;
            document.getElementById("inputDays").value = 30;
        }

        // --- è™•ç†æ’é™¤åå–® ---
        let excludedDocs = new Array(10).fill(false);
        let hasExclusion = false;
        let docListStr = "";

        if (excludedStr) {
            const parts = excludedStr.replace(/ã€/g, ",").replace(/ï¼Œ/g, ",").split(",");
            parts.forEach(p => {
                let name = p.trim().toUpperCase();
                for (let i = 0; i < 10; i++) {
                    let docName = "é†«å¸«" + String.fromCharCode(64 + (i + 1));
                    if (name === docName) {
                        excludedDocs[i] = true;
                        hasExclusion = true;
                        docListStr += name + " ";
                    }
                }
            });
            if (!hasExclusion) {
                alert("æŒ‡å®šæ’é™¤é†«å¸«æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥å¦‚ã€Œé†«å¸«A,é†«å¸«Bã€ã€‚æœ¬ç­è¡¨å°‡ä¸æ’é™¤ä»»ä½•ç­åˆ¥");
            }
        }

        // --- æ¨™é¡Œç”Ÿæˆ ---
        const chiMonths = ["", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å", "åä¸€", "åäºŒ"];
        globalTitle = `${dept}${chiMonths[mNum]}æœˆç­è¡¨`;
        document.getElementById("resultTitle").innerText = globalTitle;

        // === 2. æ ¸å¿ƒæ’ç­é‚è¼¯ ===
        let schedule = []; 
        let lastShift = new Array(10).fill("");
        let shiftCounts = new Array(10).fill(0);
        
        // æ–°å¢ï¼šç”¨ä¾†çµ±è¨ˆæ¯å€‹äººå„ç¨®ç­åˆ¥çš„æ•¸é‡ (for çµ±è¨ˆè¡¨)
        // stats[doc_index] = { "ç™½ç­":0, "å°å¤œ":0, "å¤§å¤œ":0, "ä¼‘":0 }
        let stats = Array.from({length: 10}, () => ({ "ç™½ç­":0, "å°å¤œ":0, "å¤§å¤œ":0, "ä¼‘":0 }));

        let attemptCount = 0;
        const dailyShifts = ["ç™½ç­", "å°å¤œ", "å¤§å¤œ"];
        let isSuccess = false;

        while (attemptCount < 1000) {
            attemptCount++;
            isSuccess = true;
            schedule = [];
            for (let i = 0; i < 10; i++) { lastShift[i] = ""; shiftCounts[i] = 0; }
            
            // é‡ç½®çµ±è¨ˆ (å› ç‚ºæ¯æ¬¡ retry éƒ½è¦é‡æ–°ç®—)
            stats = Array.from({length: 10}, () => ({ "ç™½ç­":0, "å°å¤œ":0, "å¤§å¤œ":0, "ä¼‘":0 }));

            for (let day = 1; day <= daysInMonth; day++) {
                let daySchedule = new Array(10).fill("");
                let availableWorkers = [];
                for (let i = 0; i < 10; i++) availableWorkers.push(i);

                for (let s = 0; s < 3; s++) {
                    let shiftName = dailyShifts[s];
                    let validPick = false;
                    let safetyCount = 0;
                    let minCurrentCounts = 100;
                    
                    for (let i = 0; i < 10; i++) {
                        if (shiftCounts[i] < minCurrentCounts) minCurrentCounts = shiftCounts[i];
                    }

                    while (!validPick && safetyCount < 50) {
                        safetyCount++;
                        let randIdx = Math.floor(Math.random() * availableWorkers.length);
                        let candidate = availableWorkers[randIdx];
                        validPick = true;

                        if (shiftName === "ç™½ç­" && lastShift[candidate] === "å°å¤œ") validPick = false;
                        if (hasExclusion && excludedDocs[candidate] && shiftName === targetShift) validPick = false;
                        if (shiftCounts[candidate] >= (minCurrentCounts + 2) && safetyCount < 10) validPick = false;

                        if (validPick) {
                            daySchedule[candidate] = shiftName;
                            shiftCounts[candidate]++;
                            stats[candidate][shiftName]++; // æ–°å¢ï¼šè¨˜éŒ„çµ±è¨ˆ
                            availableWorkers.splice(randIdx, 1);
                        }
                    }
                    if (!validPick) { isSuccess = false; break; }
                }
                
                if (!isSuccess) break;

                while (availableWorkers.length > 0) {
                    let c = availableWorkers.shift();
                    daySchedule[c] = "ä¼‘";
                    stats[c]["ä¼‘"]++; // æ–°å¢ï¼šè¨˜éŒ„çµ±è¨ˆ
                }

                schedule.push(daySchedule);
                for (let i = 0; i < 10; i++) { lastShift[i] = daySchedule[i]; }
            }

            if (isSuccess) {
                let max = Math.max(...shiftCounts);
                let min = Math.min(...shiftCounts);
                if ((max - min) <= 1) break;
            }
        }

        if (!isSuccess) {
            alert("é‹ç®—è¶…æ™‚ï¼Œè«‹é‡è©¦ã€‚");
            return;
        }

        // å„²å­˜è³‡æ–™ä¾›åŒ¯å‡ºä½¿ç”¨
        globalScheduleData = schedule;
        globalDocs = [];
        for (let i = 1; i <= 10; i++) globalDocs.push(`é†«å¸«${String.fromCharCode(64 + i)}`);

        // === 3. è¼¸å‡º HTML è¡¨æ ¼ (æ–°å¢é€±æœ«åˆ¤æ–·) ===
        // å‡è¨­ä»Šå¹´
        const currentYear = new Date().getFullYear();
        
        // ä¿®æ”¹ï¼šæ–°å¢ã€Œæ˜ŸæœŸã€æ¬„ä½
        let html = `<table><thead><tr><th>æ—¥æœŸ</th><th>æ˜ŸæœŸ</th>`;
        globalDocs.forEach(doc => { html += `<th>${doc}</th>`; });
        html += `</tr></thead><tbody>`;

        const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

        for (let d = 0; d < schedule.length; d++) {
            // æ–°å¢ï¼šè¨ˆç®—æ—¥æœŸç‰©ä»¶èˆ‡æ˜ŸæœŸ
            let dateObj = new Date(currentYear, mNum - 1, d + 1);
            let dayOfWeek = dateObj.getDay(); // 0=é€±æ—¥, 6=é€±å…­
            let isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
            let rowClass = isWeekend ? "weekend-row" : "";
            let weekStr = weekDays[dayOfWeek];

            html += `<tr class="${rowClass}"><td>${d + 1}</td><td>${weekStr}</td>`;
            
            for (let doc = 0; doc < 10; doc++) {
                let val = schedule[d][doc];
                let cssClass = "";
                if (val === "å¤§å¤œ") cssClass = "shift-bn";
                else if (val === "å°å¤œ") cssClass = "shift-sn";
                else if (val === "ç™½ç­") cssClass = "shift-day";
                else cssClass = "shift-off";
                
                html += `<td class="${cssClass}">${val}</td>`;
            }
            html += `</tr>`;
        }
        html += `</tbody></table>`;
        document.getElementById("tableContainer").innerHTML = html;

        // === 4. æ–°å¢ï¼šè¼¸å‡ºçµ±è¨ˆè¡¨ ===
        let statsHtml = `<table><thead><tr><th>é†«å¸«</th><th>ç™½ç­</th><th>å°å¤œ</th><th>å¤§å¤œ</th><th>ä¼‘å‡</th><th>ç¸½ä¸Šç­æ•¸</th></tr></thead><tbody>`;
        for(let i=0; i<10; i++) {
            let totalWork = stats[i]["ç™½ç­"] + stats[i]["å°å¤œ"] + stats[i]["å¤§å¤œ"];
            statsHtml += `<tr>
                <td>${globalDocs[i]}</td>
                <td>${stats[i]["ç™½ç­"]}</td>
                <td>${stats[i]["å°å¤œ"]}</td>
                <td>${stats[i]["å¤§å¤œ"]}</td>
                <td>${stats[i]["ä¼‘"]}</td>
                <td><strong>${totalWork}</strong></td>
            </tr>`;
        }
        statsHtml += `</tbody></table>`;
        document.getElementById("statsTable").innerHTML = statsHtml;
        document.getElementById("statsContainer").style.display = "block";

        let msg = `æ’ç­å®Œæˆï¼\næ¨™é¡Œï¼š${globalTitle}\nå¤©æ•¸ï¼š${daysInMonth} å¤©`;
        if (hasExclusion) msg += `\nè¦å‰‡ï¼šã€${docListStr.trim()}ã€‘ä¸æ’ã€${targetShift}ã€‘ã€‚`;
        // alert(msg); 
    }

    // === æ–°å¢ï¼šåŒ¯å‡º Excel (CSV) åŠŸèƒ½ ===
    function exportToCSV() {
        if (globalScheduleData.length === 0) {
            alert("è«‹å…ˆç”¢ç”Ÿç­è¡¨ï¼");
            return;
        }

        // BOM for Excel to read UTF-8 correctly
        let csvContent = "\uFEFF";
        
        // æ¨™é¡Œåˆ—
        csvContent += "æ—¥æœŸ,";
        globalDocs.forEach(doc => { csvContent += doc + ","; });
        csvContent += "\n";

        // è³‡æ–™åˆ—
        globalScheduleData.forEach((row, index) => {
            csvContent += `${index + 1},`; // æ—¥æœŸ
            row.forEach(shift => { csvContent += shift + ","; });
            csvContent += "\n";
        });

        // å»ºç«‹ä¸‹è¼‰é€£çµ
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `${globalTitle}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
