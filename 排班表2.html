<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«å¸«å°ˆç”¨æ™ºèƒ½æ’ç­ç³»çµ±</title>
    <style>
        :root {
            --primary-color: #0056b3; /* é†«ç™‚è— */
            --secondary-color: #f0f7ff; /* æ·ºè—èƒŒæ™¯ */
            --border-color: #dde0e3;
            --text-color: #333;
            --danger-color: #dc3545;
            --night-color: #d32f2f; /* å¤§å¤œç´… */
            --small-night-color: #1976d2; /* å°å¤œè— */
            --off-color: #9e9e9e; /* ä¼‘å‡ç° */
        }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background-color: #f4f6f8;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 15px;
        }

        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* è¼¸å…¥å€å¡Šæ¨£å¼ */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        input, select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
        }

        /* æŒ‰éˆ•å€å¡Š */
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-generate {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 86, 179, 0.2);
        }

        .btn-generate:hover {
            background-color: #004494;
            transform: translateY(-1px);
        }

        .btn-print {
            background-color: #6c757d;
            color: white;
        }

        .btn-print:hover {
            background-color: #5a6268;
        }

        /* çµæœæ¨™é¡Œ */
        #resultTitle {
            text-align: center;
            margin-top: 40px;
            font-size: 22px;
            color: #333;
            font-weight: bold;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-responsive {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            white-space: nowrap;
        }

        tr:nth-child(even) {
            background-color: #fafafa;
        }

        tr:hover {
            background-color: #f1f8ff;
        }

        /* ç­åˆ¥é¡è‰² */
        .shift-day { font-weight: bold; color: black; }
        .shift-sn { font-weight: bold; color: var(--small-night-color); }
        .shift-bn { font-weight: bold; color: var(--night-color); }
        .shift-off { color: var(--off-color); }

        /* åˆ—å°è¨­å®š */
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; width: 100%; max-width: none; padding: 0; }
            .input-grid, .btn-group, header { display: none; }
            #resultTitle { margin-top: 0; font-size: 24px; }
            table { font-size: 12px; }
            th { background-color: #ddd !important; color: black !important; -webkit-print-color-adjust: exact; }
            .shift-sn { color: blue !important; }
            .shift-bn { color: red !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ç¸½é†«å¸«çš„æ•‘æ˜Ÿ</h1>
        <p style="color: #666; font-size: 14px; margin-top:5px;">CHIU é•·åºšç´€å¿µé†«é™¢æ’ç­ç³»çµ±</p>
    </header>

    <div class="input-grid">
        <div class="input-group">
            <label for="inputDept">1. ç§‘åˆ¥åç¨±</label>
            <input type="text" id="inputDept" placeholder="ä¾‹å¦‚ï¼šæ€¥è¨ºç§‘" value="æ€¥è¨ºç§‘">
        </div>

        <div class="input-group">
            <label for="inputMonth">2. æœˆä»½ (1-12)</label>
            <input type="number" id="inputMonth" placeholder="è¼¸å…¥æ•¸å­—" min="1" max="12">
        </div>

        <div class="input-group">
            <label for="inputDays">3. æœ¬æœˆå¤©æ•¸</label>
            <input type="number" id="inputDays" placeholder="é è¨­ 30" min="28" max="31" value="30">
        </div>

        <div class="input-group">
            <label for="inputExcluded">4. æŒ‡å®šæ’é™¤é†«å¸«</label>
            <input type="text" id="inputExcluded" placeholder="å¦‚ï¼šé†«å¸«A,é†«å¸«B">
        </div>

        <div class="input-group">
            <label for="selectShift">5. è©²é†«å¸«ä¸æ’ä¹‹ç­åˆ¥</label>
            <select id="selectShift">
                <option value="å¤§å¤œ">å¤§å¤œ</option>
                <option value="å°å¤œ">å°å¤œ</option>
                <option value="ç™½ç­">ç™½ç­</option>
            </select>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-generate" onclick="generateSchedule()">âš¡ é–‹å§‹è‡ªå‹•æ’ç­</button>
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°ç­è¡¨</button>
    </div>

    <h2 id="resultTitle"></h2>
    <div id="tableContainer" class="table-responsive"></div>
</div>

<script>
    function generateSchedule() {
        // === 1. è®€å–èˆ‡é©—è­‰è¼¸å…¥ (å°æ‡‰ VBA A14, A17, A11) ===
        const dept = document.getElementById("inputDept").value.trim();
        const monthVal = document.getElementById("inputMonth").value.trim();
        let daysInMonth = parseInt(document.getElementById("inputDays").value);
        const excludedStr = document.getElementById("inputExcluded").value.trim();
        const targetShift = document.getElementById("selectShift").value;

        // A14 åš´æ ¼é©—è­‰
        if (!monthVal || isNaN(monthVal)) {
            alert("ã€éŒ¯èª¤ã€‘æœˆä»½æ ¼å¼éŒ¯èª¤ï¼\nè«‹è¼¸å…¥ 1 åˆ° 12 ä¹‹é–“çš„æ•¸å­—ã€‚");
            return;
        }
        const mNum = parseInt(monthVal);
        if (mNum < 1 || mNum > 12) {
            alert(`ã€éŒ¯èª¤ã€‘æœˆä»½éŒ¯èª¤ï¼\næ‚¨è¼¸å…¥äº†: ${mNum}\nè«‹è¼¸å…¥ 1 åˆ° 12 ä¹‹é–“çš„æ•¸å­—ã€‚`);
            return;
        }

        // A11 å¤©æ•¸é˜²å‘†
        if (isNaN(daysInMonth) || daysInMonth < 28 || daysInMonth > 31) {
            alert("å¤©æ•¸è¨­å®šç•°å¸¸ (è«‹è¼¸å…¥ 28~31)ï¼Œæœ¬æ¬¡å°‡ä»¥ 30 å¤©è¨ˆç®—ã€‚");
            daysInMonth = 30;
            document.getElementById("inputDays").value = 30;
        }

        // è™•ç†æ’é™¤åå–® (å°æ‡‰ VBA A5)
        // JS é™£åˆ—å¾ 0 é–‹å§‹ï¼Œé€™è£¡æˆ‘å€‘ç”¨ index 0-9 ä»£è¡¨ é†«å¸«A-é†«å¸«J
        let excludedDocs = new Array(10).fill(false);
        let hasExclusion = false;
        let docListStr = "";

        if (excludedStr) {
            // æ”¯æ´å…¨å½¢é “è™Ÿã€å…¨å½¢é€—è™Ÿ
            const parts = excludedStr.replace(/ã€/g, ",").replace(/ï¼Œ/g, ",").split(",");
            parts.forEach(p => {
                let name = p.trim().toUpperCase();
                // æ¯”å° é†«å¸«A ~ é†«å¸«J
                for (let i = 0; i < 10; i++) {
                    let docName = "é†«å¸«" + String.fromCharCode(64 + (i + 1));
                    if (name === docName) {
                        excludedDocs[i] = true;
                        hasExclusion = true;
                        docListStr += name + " ";
                    }
                }
            });
            if (!hasExclusion) {
                alert("æŒ‡å®šæ’é™¤é†«å¸«æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥å¦‚ã€Œé†«å¸«A,é†«å¸«Bã€ã€‚");
                // VBA æœƒç¹¼çºŒè·‘ï¼Œä½†é€™è£¡æˆ‘å€‘æç¤ºå¾Œç¹¼çºŒ
            }
        }

        // æº–å‚™æ¨™é¡Œ (å°æ‡‰ VBA Title Logic)
        const chiMonths = ["", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å", "åä¸€", "åäºŒ"];
        const title = `${dept}${chiMonths[mNum]}æœˆç­è¡¨`;
        document.getElementById("resultTitle").innerText = title;

        // === 2. æ ¸å¿ƒæ’ç­é‚è¼¯ (å°æ‡‰ VBA Loop) ===
        
        // è³‡æ–™çµæ§‹åˆå§‹åŒ–
        // schedule[day-1][doctor_index] (JS array 0-based)
        let schedule = []; 
        let lastShift = new Array(10).fill("");
        let shiftCounts = new Array(10).fill(0);
        let attemptCount = 0;
        const dailyShifts = ["ç™½ç­", "å°å¤œ", "å¤§å¤œ"];
        let isSuccess = false;

        // æ¨¡æ“¬ VBA Do...Loop
        while (attemptCount < 1000) { // é˜²æ­¢ç„¡çª®è¿´åœˆ
            attemptCount++;
            isSuccess = true;
            
            // é‡ç½®
            schedule = [];
            for (let i = 0; i < 10; i++) { lastShift[i] = ""; shiftCounts[i] = 0; }

            // é–‹å§‹æ¯ä¸€å¤©çš„æ’ç­
            for (let day = 1; day <= daysInMonth; day++) {
                let daySchedule = new Array(10).fill(""); // æš«å­˜ç•¶å¤©çš„ç­è¡¨
                
                // å»ºç«‹å¯ç”¨äººå“¡æ¸…å–® (0-9)
                let availableWorkers = [];
                for (let i = 0; i < 10; i++) availableWorkers.push(i);

                // æ’ ç™½ç­ -> å°å¤œ -> å¤§å¤œ
                for (let s = 0; s < 3; s++) {
                    let shiftName = dailyShifts[s];
                    let validPick = false;
                    let safetyCount = 0;

                    // è¨ˆç®—ç•¶å‰æœ€å°å€¼ (å‹•æ…‹å¹³è¡¡)
                    let minCurrentCounts = 100;
                    for (let i = 0; i < 10; i++) {
                        if (shiftCounts[i] < minCurrentCounts) minCurrentCounts = shiftCounts[i];
                    }

                    // æŠ½ç±¤è¿´åœˆ
                    while (!validPick && safetyCount < 50) {
                        safetyCount++;
                        // éš¨æ©ŸæŠ½ä¸€äºº
                        let randIdx = Math.floor(Math.random() * availableWorkers.length);
                        let candidate = availableWorkers[randIdx];
                        validPick = true;

                        // è¦å‰‡ 1: å°å¤œä¸æ¥ç™½ (VBA: If shiftName = "ç™½ç­" And lastShift(candidate) = "å°å¤œ")
                        if (shiftName === "ç™½ç­" && lastShift[candidate] === "å°å¤œ") {
                            validPick = false;
                        }

                        // è¦å‰‡ 2: æ’é™¤æŒ‡å®š (VBA: If excludedDocs(candidate) = True And shiftName = targetShift)
                        // æ³¨æ„: VBA candidate æ˜¯ 1-10, JS æ˜¯ 0-9ï¼Œé‚è¼¯é€šç”¨
                        if (hasExclusion && excludedDocs[candidate] && shiftName === targetShift) {
                            validPick = false;
                        }

                        // è¦å‰‡ 3: å‹•æ…‹å¹³è¡¡ (VBA: If shiftCounts >= min + 2 ...)
                        if (shiftCounts[candidate] >= (minCurrentCounts + 2) && safetyCount < 10) {
                            validPick = false;
                        }

                        if (validPick) {
                            daySchedule[candidate] = shiftName;
                            shiftCounts[candidate]++;
                            availableWorkers.splice(randIdx, 1); // ç§»é™¤å·²æ’ç­çš„äºº
                        }
                    }

                    if (!validPick) {
                        isSuccess = false;
                        break; // è©²ç­åˆ¥æ’å¤±æ•—ï¼Œè·³å‡º
                    }
                }
                
                if (!isSuccess) break; // è©²å¤©æ’å¤±æ•—ï¼Œè·³å‡º

                // å¡«å…¥ä¼‘å‡
                while (availableWorkers.length > 0) {
                    let c = availableWorkers.shift();
                    daySchedule[c] = "ä¼‘";
                }

                // æ›´æ–° lastShift ä¸¦å­˜å…¥ç¸½è¡¨
                schedule.push(daySchedule);
                for (let i = 0; i < 10; i++) {
                    lastShift[i] = daySchedule[i];
                }
            }

            // æœ€çµ‚å¹³è¡¡æª¢æŸ¥ (VBA Check)
            if (isSuccess) {
                let max = Math.max(...shiftCounts);
                let min = Math.min(...shiftCounts);
                if ((max - min) <= 1) {
                    break; // æˆåŠŸä¸”å¹³è¡¡ï¼ŒçµæŸå¤§è¿´åœˆ
                }
            }
        }

        if (!isSuccess) {
            alert("é‹ç®—è¶…æ™‚æˆ–æ¢ä»¶éæ–¼åš´è‹›ï¼Œè«‹é‡è©¦æˆ–æ”¾å¯¬æ¢ä»¶ã€‚");
            return;
        }

        // === 3. è¼¸å‡º HTML è¡¨æ ¼ ===
        let html = `<table><thead><tr><th>æ—¥æœŸ</th>`;
        for (let i = 1; i <= 10; i++) {
            html += `<th>é†«å¸«${String.fromCharCode(64 + i)}</th>`;
        }
        html += `</tr></thead><tbody>`;

        for (let d = 0; d < schedule.length; d++) {
            html += `<tr><td>${d + 1}</td>`; // æ—¥æœŸ
            for (let doc = 0; doc < 10; doc++) {
                let val = schedule[d][doc];
                let cssClass = "";
                if (val === "å¤§å¤œ") cssClass = "shift-bn";
                else if (val === "å°å¤œ") cssClass = "shift-sn";
                else if (val === "ç™½ç­") cssClass = "shift-day";
                else cssClass = "shift-off";
                
                html += `<td class="${cssClass}">${val}</td>`;
            }
            html += `</tr>`;
        }
        html += `</tbody></table>`;
        document.getElementById("tableContainer").innerHTML = html;

        // è¨Šæ¯æç¤º (VBA MsgBox)
        let msg = `æ’ç­å®Œæˆï¼\næ¨™é¡Œï¼š${title}\nå¤©æ•¸ï¼š${daysInMonth} å¤©`;
        if (hasExclusion) {
            msg += `\nè¦å‰‡ï¼šã€${docListStr.trim()}ã€‘ä¸æ’ã€${targetShift}ã€‘ã€‚`;
        }
        // ç‚ºäº†ä¸å¹²æ“¾ç¶²é é«”é©—ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ console æˆ–ç°¡å–®çš„ Toastï¼Œé€™è£¡ä¿ç•™ alert ä½œç‚ºç°¡å–®å›é¥‹
        // alert(msg); 
    }
</script>

</body>
</html>